<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\chatle\src\chatle\Controllers\ChatController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ChatLe.Hubs;
using ChatLe.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.SignalR;
using System.Collections.Generic;
using System.Linq;
using System;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity;
using ChatLe.ViewModels;

// For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace ChatLe.Controllers
{
    /// &lt;summary&gt;
    /// Chat API controller
    /// &lt;/summary&gt;
    [Route(&quot;api/chat&quot;)]
    public class ChatController : Controller
    {
        private readonly IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt; _chatManager;
        private readonly IHubContext&lt;ChatHub&gt; _hub;
        private readonly UserManager&lt;ChatLeUser&gt; _userManager;
        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;chatManager&quot;&gt;the chat repository manager&lt;/param&gt;
        /// &lt;param name=&quot;signalRConnectionManager&quot;&gt;the SignalR connection manager&lt;/param&gt;
        /// &lt;param name=&quot;userManager&quot;&gt;the Identity user manager&lt;/param&gt;
        public ChatController(IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt; chatManager, IHubContext&lt;ChatHub&gt; hubContext, UserManager&lt;ChatLeUser&gt; userManager)
        {
            _chatManager = chatManager;
            _hub = hubContext;
            _userManager = userManager;
        }
        /// &lt;summary&gt;
        /// Get messages in a conversation
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;id&quot;&gt;the conversation id&lt;/param&gt;
        /// &lt;returns&gt;a &lt;see cref=&quot;Task&lt;IEnumerable&lt;MessageViewModel&gt;&gt;&quot;/&gt; with the messages list as result&lt;/returns&gt;
        // GET: /&lt;controller&gt;/
        [HttpGet(&quot;{id}&quot;)]
        public async Task&lt;IEnumerable&lt;MessageViewModel&gt;&gt; Get(string id)
        {
            var messages = await _chatManager.GetMessagesAsync(id);
            var users = new List&lt;ChatLeUser&gt;(2);
            var messagesVM = new List&lt;MessageViewModel&gt;(messages.Count());
            foreach (var message in messages)
            {
                var user = users.FirstOrDefault(u =&gt; u.Id == message.UserId);
                if (user == null)
                {
                    user = await _userManager.FindByIdAsync(message.UserId);
                    if (user == null)
                        continue;
                }
                messagesVM.Add(new MessageViewModel() { Date = message.Date, From = user.UserName, Text = message.Text });
            }

            return messagesVM;
        }

        /// &lt;summary&gt;
        /// Gets conversations for the current user
        /// &lt;/summary&gt;
        /// &lt;returns&gt;a &lt;see cref=&quot;Task&lt;IEnumerable&lt;ConversationViewModel&gt;&gt;&quot;/&gt; with the conversations list as result&lt;/returns&gt;
        [HttpGet()]
        public async Task&lt;IEnumerable&lt;ConversationViewModel&gt;&gt; Get()
        {
            var userName = HttpContext.User.Identity.Name;
            if (string.IsNullOrEmpty(userName))
            {
                return null;
            }

            var conversations = await _chatManager.GetConversationsAsync(userName);
            if (conversations == null)
                return null;

            var length = conversations.Count();
            var users = new List&lt;ChatLeUser&gt;(length);
            var conversationsVM = new List&lt;ConversationViewModel&gt;(length);
            foreach (var conv in conversations)
            {
                var attendees = conv.Attendees;
                var attendeesVM = new List&lt;AttendeeViewModel&gt;(attendees.Count);
                foreach (var attendee in attendees)
                {
                    var u = await _userManager.FindByIdAsync(attendee.UserId);
                    if (u == null)
                        continue;

                    users.Add(u);
                    attendeesVM.Add(new AttendeeViewModel() { UserId = u.UserName });
                }

                if (attendeesVM.Count &lt; 2)
                    continue;

                var messages = conv.Messages;
                var messagesVM = new List&lt;MessageViewModel&gt;(messages.Count());
                foreach (var message in messages)
                {
                    var user = users.FirstOrDefault(u =&gt; u.Id == message.UserId);
                    if (user == null)
                    {
                        user = await _userManager.FindByIdAsync(message.UserId);
                        if (user == null)
                            continue;
                    }
                    messagesVM.Add(new MessageViewModel() { ConversationId = conv.Id, Date = message.Date, From = user.UserName, Text = message.Text });
                }

                conversationsVM.Add(new ConversationViewModel() { Id = conv.Id, Attendees = attendeesVM, Messages = messagesVM });
            }

            return conversationsVM;
        }

        /// &lt;summary&gt;
        /// Send a message in a conversation asyncronously
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;data&quot;&gt;The message to send&lt;/param&gt;
        /// &lt;returns&gt;a &lt;see cref=&quot;Task&quot;/&gt;&lt;/returns&gt;
        [HttpPost()]
        public async Task SendMessage([FromBody] MessageToSend data)
        {
            var to = data.To;
            var text = data.Text;

            var userName = HttpContext.User.Identity.Name;
            var message = new Message() { ConversationId = to, Text = text, Date = DateTime.Now };
            var conv = await _chatManager.AddMessageAsync(userName, to, message);
            if (conv == null)
                return;
            foreach (var attendee in conv.Attendees)
            {
                var user = await _userManager.FindByIdAsync(attendee.UserId);
                if (user != null &amp;&amp; user.UserName != userName)
                    await _hub.Clients.Group(user.UserName).SendAsync(&quot;messageReceived&quot;, new { conversationId = to, date = message.Date, from = HttpContext.User.Identity.Name, text = text });
            }
        }

        /// &lt;summary&gt;
        /// Get or create a one to one conversation asyncronously
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;data&quot;&gt;Initial message to send&lt;/param&gt;
        /// &lt;returns&gt;a &lt;see cref=&quot;Task&lt;string&gt;&quot;/&gt; with the conversation id as result or null if the user doesn&#39;t exist&lt;/returns&gt;
        [HttpPost(&quot;conv&quot;)]
        [Produces(&quot;application/json&quot;)]
        public async Task&lt;string&gt; CreateConversation([FromBody] MessageToSend data)
        {
            var to = data.To;
            var text = data.Text;

            var userName = HttpContext.User.Identity.Name;
            
            var conversation = await _chatManager.GetOrCreateConversationAsync(userName, to, text);

            var users = new List&lt;ChatLeUser&gt;(conversation.Attendees.Count);
            var attendees = new List&lt;AttendeeViewModel&gt;(conversation.Attendees.Count);
            foreach(var attendee in conversation.Attendees)
            {
                var u = await _userManager.FindByIdAsync(attendee.UserId);
                if (u == null)
                    return null;

                users.Add(u);
                attendees.Add(new AttendeeViewModel() { UserId = u.UserName });
            }
            var messages = new List&lt;MessageViewModel&gt;(conversation.Messages.Count);
            foreach(var message in conversation.Messages)
            {
                var user = users.FirstOrDefault(u =&gt; u.Id == message.UserId);
                if (user == null)
                {
                    user = await _userManager.FindByIdAsync(message.UserId);
                    if (user == null)
                        continue;
                }
                messages.Add(new MessageViewModel() { Date = message.Date, From = user.UserName, Text = message.Text });
            }

            await _hub.Clients.Group(to).SendAsync(&quot;joinConversation&quot;, new 
            { 
                id = conversation.Id,
                attendees = attendees.Select(a =&gt; new { userId = a.UserId }),
                messages = messages.Select(m =&gt; new 
                    { 
                        date = m.Date, 
                        from = m.From, 
                        text = m.Text 
                    }) 
            });
            
            return conversation.Id;
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[31,9,31,203,1],[32,9,32,10,1],[33,13,33,40,1],[34,13,34,31,1],[35,13,35,40,1],[36,9,36,10,1],[45,9,45,10,1],[46,13,46,68,1],[47,13,47,49,1],[48,13,48,75,1],[49,13,49,20,1],[49,22,49,33,1],[49,34,49,36,1],[49,37,49,45,1],[50,13,50,14,1],[51,17,51,54,1],[51,54,51,76,0],[51,76,51,78,1],[51,17,51,78,1],[52,17,52,34,1],[53,17,53,18,1],[54,21,54,77,1],[55,21,55,38,1],[56,25,56,34,1],[57,17,57,18,1],[58,17,58,123,1],[59,13,59,14,1],[61,13,61,31,1],[62,9,62,10,1],[70,9,70,10,1],[71,13,71,59,1],[72,13,72,48,1],[73,13,73,14,0],[74,17,74,29,0],[77,13,77,84,1],[78,13,78,39,1],[79,17,79,29,0],[81,13,81,48,1],[82,13,82,54,1],[83,13,83,75,1],[84,13,84,20,1],[84,22,84,30,1],[84,31,84,33,1],[84,34,84,47,1],[85,13,85,14,1],[86,17,86,48,1],[87,17,87,80,1],[88,17,88,24,1],[88,26,88,38,1],[88,39,88,41,1],[88,42,88,51,1],[89,17,89,18,1],[90,21,90,79,1],[91,21,91,35,1],[92,25,92,34,1],[94,21,94,34,1],[95,21,95,86,1],[96,17,96,18,1],[98,17,98,43,1],[99,21,99,30,1],[101,17,101,46,1],[102,17,102,79,1],[103,17,103,24,1],[103,26,103,37,1],[103,38,103,40,1],[103,41,103,49,1],[104,17,104,18,1],[105,21,105,58,1],[105,58,105,80,1],[105,80,105,82,1],[105,21,105,82,1],[106,21,106,38,1],[107,21,107,22,1],[108,25,108,81,1],[109,25,109,42,1],[110,29,110,38,1],[111,21,111,22,1],[112,21,112,153,1],[113,17,113,18,1],[115,17,115,131,1],[116,13,116,14,1],[118,13,118,36,1],[119,9,119,10,1],[128,9,128,10,1],[129,13,129,30,1],[130,13,130,34,1],[132,13,132,59,1],[133,13,133,99,1],[134,13,134,82,1],[135,13,135,30,1],[136,17,136,24,1],[137,13,137,20,1],[137,22,137,34,1],[137,35,137,37,1],[137,38,137,52,1],[138,13,138,14,1],[139,17,139,78,1],[140,17,140,63,1],[141,21,141,192,1],[142,13,142,14,1],[143,9,143,10,1],[153,9,153,10,1],[154,13,154,30,1],[155,13,155,34,1],[157,13,157,59,1],[159,13,159,100,1],[161,13,161,76,1],[162,13,162,87,1],[163,13,163,20,1],[163,21,163,33,1],[163,34,163,36,1],[163,37,163,59,1],[164,13,164,14,1],[165,17,165,75,1],[166,17,166,31,1],[167,21,167,33,1],[169,17,169,30,1],[170,17,170,80,1],[171,13,171,14,1],[172,13,172,84,1],[173,13,173,20,1],[173,21,173,32,1],[173,33,173,35,1],[173,36,173,57,1],[174,13,174,14,1],[175,17,175,54,1],[175,54,175,76,1],[175,76,175,78,1],[175,17,175,78,1],[176,17,176,34,1],[177,17,177,18,1],[178,21,178,77,1],[179,21,179,38,1],[180,25,180,34,1],[181,17,181,18,1],[182,17,182,121,1],[183,13,183,14,1],[185,13,188,51,1],[188,51,188,76,0],[188,76,189,49,1],[189,49,194,22,0],[194,22,195,16,1],[185,13,195,16,1],[197,13,197,36,1],[198,9,198,10,1]]);
    </script>
  </body>
</html>