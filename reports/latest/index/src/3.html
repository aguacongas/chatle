<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\chatle\src\chatle\Startup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using chatle.Hubs;
using ChatLe.Cryptography;
using ChatLe.Hubs;
using ChatLe.Models;
using Google.Apis.Auth.OAuth2;
using Microsoft.AspNetCore.Antiforgery;
using Microsoft.AspNetCore.Authentication.OAuth;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Security.Claims;

namespace ChatLe
{
    public class Startup
    {
        enum DBEngine
        {
            SqlServer,
            InMemory,
            Redis,
            SQLite,
            MySql,
            Firebase
        }

        readonly IHostingEnvironment _environment;
        public ILoggerFactory LoggerFactory { get; private set; }
        public Startup(IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            var builder = new ConfigurationBuilder()
                .SetBasePath(env.ContentRootPath)
                .AddJsonFile(&quot;config.json&quot;)
                .AddJsonFile($&quot;config.{env.EnvironmentName}.json&quot;, optional: true);

            if (env.IsDevelopment())
            {
                // For more details on using the user secret store see http://go.microsoft.com/fwlink/?LinkID=532709
                builder.AddUserSecrets&lt;Startup&gt;();
                loggerFactory.AddDebug();
            }

            builder.AddEnvironmentVariables();

            Configuration = builder.Build();

            _environment = env;
            LoggerFactory = loggerFactory;
            loggerFactory.AddAzureWebAppDiagnostics();

            loggerFactory.AddConsole();
        }

        public IConfiguration Configuration { get; private set; }

        public virtual void ConfigureServices(IServiceCollection services)
        {
            services
                .Configure&lt;HubSettings&gt;(hubSettings =&gt; Configuration.GetSection(&quot;HubSettings&quot;).Bind(hubSettings))
                .AddChatLe(options =&gt; options.UserPerPage = int.Parse(Configuration[&quot;ChatConfig:UserPerPage&quot;]))
                .AddCors()
                .AddAntiforgery(options =&gt; options.HeaderName = &quot;X-XSRF-TOKEN&quot;);

            ConfigureEntity(services);

            services.AddMvc()
                .AddJsonOptions(options =&gt;
                {
                    options.SerializerSettings.NullValueHandling = NullValueHandling.Ignore;
                });

            services.AddSignalR();

            var authServices = services.AddAuthentication();
            if (Configuration[&quot;Authentication:Facebook:AppId&quot;] != null)
            { 
                authServices.AddFacebook(facebookOptions =&gt;
                {
                    facebookOptions.AppId = Configuration[&quot;Authentication:Facebook:AppId&quot;];
                    facebookOptions.AppSecret = Configuration[&quot;Authentication:Facebook:AppSecret&quot;];
                    facebookOptions.SaveTokens = true;
                });
            }

            if (Configuration[&quot;Authentication:Twitter:ConsumerKey&quot;] != null)
            {
                authServices.AddTwitter(twitterOptions =&gt;
                {
                    twitterOptions.ConsumerKey = Configuration[&quot;Authentication:Twitter:ConsumerKey&quot;];
                    twitterOptions.ConsumerSecret = Configuration[&quot;Authentication:Twitter:ConsumerSecret&quot;];
                    twitterOptions.SaveTokens = true;

                });
            }
            if (Configuration[&quot;Authentication:Google:ClientId&quot;] != null)
            {
                authServices.AddGoogle(googleOption =&gt;
                {
                    googleOption.ClientId = Configuration[&quot;Authentication:Google:ClientId&quot;];
                    googleOption.ClientSecret = Configuration[&quot;Authentication:Google:ClientSecret&quot;];
                    googleOption.SaveTokens = true;
                });
            }
            if (Configuration[&quot;Authentication:MicrosoftAccount:ClientId&quot;] != null)
            {
                authServices.AddMicrosoftAccount(microsoftAccountOptions =&gt;
                {
                    microsoftAccountOptions.ClientId = Configuration[&quot;Authentication:MicrosoftAccount:ClientId&quot;];
                    microsoftAccountOptions.ClientSecret = Configuration[&quot;Authentication:MicrosoftAccount:ClientSecret&quot;];
                    microsoftAccountOptions.SaveTokens = true;
                });
            }
            if (Configuration[&quot;Authentication:Github:ClientId&quot;] != null)
            {
                authServices.AddOAuth(&quot;Github&quot;, options =&gt;
                {
                    options.ClientId = Configuration[&quot;Authentication:Github:ClientId&quot;];
                    options.ClientSecret = Configuration[&quot;Authentication:Github:ClientSecret&quot;];
                    options.CallbackPath = new PathString(&quot;/signin-github&quot;);
                    options.AuthorizationEndpoint = &quot;https://github.com/login/oauth/authorize&quot;;
                    options.TokenEndpoint = &quot;https://github.com/login/oauth/access_token&quot;;
                    options.UserInformationEndpoint = &quot;https://api.github.com/user&quot;;
                    options.ClaimsIssuer = &quot;OAuth2-Github&quot;;
                    options.SaveTokens = true;
                    // Retrieving user information is unique to each provider.
                    options.Events = new OAuthEvents
                    {
                        OnCreatingTicket = async context =&gt;
                        {
                            // Get the GitHub user
                            var request = new HttpRequestMessage(HttpMethod.Get, context.Options.UserInformationEndpoint);
                            request.Headers.Authorization = new AuthenticationHeaderValue(&quot;Bearer&quot;, context.AccessToken);
                            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(&quot;application/json&quot;));

                            var response = await context.Backchannel.SendAsync(request, context.HttpContext.RequestAborted);
                            response.EnsureSuccessStatusCode();

                            var user = JObject.Parse(await response.Content.ReadAsStringAsync());

                            var identifier = user.Value&lt;string&gt;(&quot;id&quot;);
                            if (!string.IsNullOrEmpty(identifier))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimTypes.NameIdentifier, identifier,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var userName = user.Value&lt;string&gt;(&quot;login&quot;);
                            if (!string.IsNullOrEmpty(userName))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimsIdentity.DefaultNameClaimType, userName,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var name = user.Value&lt;string&gt;(&quot;name&quot;);
                            if (!string.IsNullOrEmpty(name))
                            {
                                context.Identity.AddClaim(new Claim(
                                    &quot;urn:github:name&quot;, name,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var email = user.Value&lt;string&gt;(&quot;email&quot;);
                            if (!string.IsNullOrEmpty(email))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimTypes.Email, email,
                                    ClaimValueTypes.Email, context.Options.ClaimsIssuer));
                            }

                            var link = user.Value&lt;string&gt;(&quot;url&quot;);
                            if (!string.IsNullOrEmpty(link))
                            {
                                context.Identity.AddClaim(new Claim(
                                    &quot;urn:github:url&quot;, link,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }
                        }
                    };
                });
            }
        }

        private void ConfigureEntity(IServiceCollection services)
        {
            var identityBuilder = services.AddIdentity&lt;ChatLeUser, IdentityRole&gt;(options =&gt;
                        {
                            var userOptions = options.User;
                            userOptions.AllowedUserNameCharacters += &quot; &quot;;
                        })
                .AddDefaultTokenProviders();

            var identityEngine = (DBEngine)Enum.Parse(typeof(DBEngine), Configuration[&quot;IdentityDatabase&quot;]);

            switch(identityEngine)
            {
                case DBEngine.Redis:
                    identityBuilder.AddRedisStores(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;]);
                    break;
                case DBEngine.Firebase:
                    identityBuilder.AddFirebaseStores(Configuration[&quot;FirebaseOptions:DatabaseUrl&quot;], provider =&gt;
                    {
                        using (var utility = new Utility(Configuration[&quot;FirebaseOptions:SecureKey&quot;]))
                        {
                            using (var stream = utility.DecryptFile(&quot;firebase-key.json.enc&quot;).GetAwaiter().GetResult())
                            {
                                return GoogleCredential.FromStream(stream)
                                    .CreateScoped(&quot;https://www.googleapis.com/auth/userinfo.email&quot;, &quot;https://www.googleapis.com/auth/firebase.database&quot;)
                                    .UnderlyingCredential;
                            }
                        }
                    });
                    break;
                default:
                    identityBuilder.AddEntityFrameworkStores&lt;ChatLeIdentityDbContext&gt;();
                    break;
            }

            var dbEngine = (DBEngine)Enum.Parse(typeof(DBEngine), Configuration[&quot;DatabaseEngine&quot;]);
            
            if (dbEngine != DBEngine.Firebase)
            {
                services.AddDbContext&lt;ChatLeIdentityDbContext&gt;(options =&gt;
                {
                    if (_environment.IsDevelopment())
                        options.EnableSensitiveDataLogging();

                    switch (dbEngine)
                    {
                        case DBEngine.InMemory:
                            options.UseInMemoryDatabase(&quot;chatle&quot;);
                            break;
                        case DBEngine.SqlServer:
                            options.UseSqlServer(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.SqlServer&quot;));
                            break;
                        case DBEngine.SQLite:
                            options.UseSqlite(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.Sqlite&quot;));
                            break;
                        case DBEngine.MySql:
                            options.UseMySql(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.MySql&quot;));
                            break;
                }
                });
            }
            else
            {
                services.AddFirebaseChatStore();
            }
        }

        public virtual void Configure(IApplicationBuilder app, IAntiforgery antiforgery)
        {

            ConfigureErrors(app);

            var logger = LoggerFactory.CreateLogger(&quot;request&quot;);
            app.UseCors(
                builder =&gt; builder.AllowAnyOrigin()
                    .AllowAnyHeader()
                    .AllowAnyMethod()
                    .AllowCredentials())
                .UseStaticFiles()
                .UseWebSockets()
                .UseAuthentication()
                .Map(&quot;/xhrf&quot;, a =&gt; a.Run(async context =&gt;
                {
                    var tokens = antiforgery.GetAndStoreTokens(context);
                    context.Response.Cookies.Append(&quot;XSRF-TOKEN&quot;, tokens.RequestToken, new CookieOptions() { HttpOnly = false });
                    await context.Response.WriteAsync(tokens.RequestToken);
                }))
                .Map(&quot;/cls&quot;, a =&gt; a.Run(async context =&gt;
                {
                    var response = context.Response;
                    foreach (var cookie in context.Request.Cookies)
                    {
                        response.Cookies.Delete(cookie.Key);
                    }
                    await context.Response.WriteAsync(string.Empty);
                }))
                .UseSignalR(configure =&gt;
                {
                    configure.MapHub&lt;ChatHub&gt;(&quot;/chat&quot;);
                })
                .UseMvc(routes =&gt;
                {
                    routes.MapRoute(
                    name: &quot;default&quot;,
                    template: &quot;{controller}/{action}/{id?}&quot;,
                    defaults: new { controller = &quot;Home&quot;, action = &quot;Index&quot; });
                })
                .UseChatLe();
        }

        protected virtual void ConfigureErrors(IApplicationBuilder app)
        {
            if (string.Equals(_environment.EnvironmentName, &quot;Development&quot;, StringComparison.OrdinalIgnoreCase))
            {
                app.UseBrowserLink();
                app.UseDeveloperExceptionPage();
                app.UseDatabaseErrorPage();
            }
            else
            {
                // Add Error handling middleware which catches all application specific errors and
                // send the request to the following path or controller action.
                app.UseExceptionHandler(&quot;/Home/Error&quot;);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[38,47,38,51,0],[38,52,38,64,0],[39,9,39,78,0],[40,9,40,10,0],[41,13,44,84,0],[46,13,46,37,0],[47,13,47,14,0],[49,17,49,51,0],[50,17,50,42,0],[51,13,51,14,0],[53,13,53,47,0],[55,13,55,45,0],[57,13,57,32,0],[58,13,58,43,0],[59,13,59,55,0],[61,13,61,40,0],[62,9,62,10,0],[64,47,64,51,0],[64,52,64,64,0],[67,9,67,10,0],[68,13,69,56,0],[69,56,69,113,0],[69,113,70,39,0],[70,39,70,111,0],[70,111,72,44,0],[72,44,72,79,0],[72,79,72,81,0],[68,13,72,81,0],[74,13,74,39,0],[76,13,78,17,0],[78,17,78,18,0],[78,18,79,21,0],[79,21,79,93,0],[79,93,80,17,0],[80,17,80,18,0],[80,18,80,20,0],[76,13,80,20,0],[82,13,82,35,0],[84,13,84,61,0],[85,13,85,72,0],[86,13,86,14,0],[87,17,88,17,0],[88,17,88,18,0],[88,18,89,21,0],[89,21,89,92,0],[89,92,90,21,0],[90,21,90,100,0],[90,100,91,21,0],[91,21,91,55,0],[91,55,92,17,0],[92,17,92,18,0],[92,18,92,20,0],[87,17,92,20,0],[93,13,93,14,0],[95,13,95,77,0],[96,13,96,14,0],[97,17,98,17,0],[98,17,98,18,0],[98,18,99,21,0],[99,21,99,102,0],[99,102,100,21,0],[100,21,100,108,0],[100,108,101,21,0],[101,21,101,54,0],[101,54,103,17,0],[103,17,103,18,0],[103,18,103,20,0],[97,17,103,20,0],[104,13,104,14,0],[105,13,105,73,0],[106,13,106,14,0],[107,17,108,17,0],[108,17,108,18,0],[108,18,109,21,0],[109,21,109,93,0],[109,93,110,21,0],[110,21,110,101,0],[110,101,111,21,0],[111,21,111,52,0],[111,52,112,17,0],[112,17,112,18,0],[112,18,112,20,0],[107,17,112,20,0],[113,13,113,14,0],[114,13,114,83,0],[115,13,115,14,0],[116,17,117,17,0],[117,17,117,18,0],[117,18,118,21,0],[118,21,118,114,0],[118,114,119,21,0],[119,21,119,122,0],[119,122,120,21,0],[120,21,120,63,0],[120,63,121,17,0],[121,17,121,18,0],[121,18,121,20,0],[116,17,121,20,0],[122,13,122,14,0],[123,13,123,73,0],[124,13,124,14,0],[125,17,126,17,0],[126,17,126,18,0],[126,18,127,21,0],[127,21,127,88,0],[127,88,128,21,0],[128,21,128,96,0],[128,96,129,21,0],[129,21,129,77,0],[129,77,130,21,0],[130,21,130,96,0],[130,96,131,21,0],[131,21,131,91,0],[131,91,132,21,0],[132,21,132,85,0],[132,85,133,21,0],[133,21,133,60,0],[133,60,134,21,0],[134,21,134,47,0],[134,47,136,21,0],[136,21,139,25,0],[139,25,139,26,0],[139,26,141,29,0],[141,29,141,123,0],[141,123,142,29,0],[142,29,142,122,0],[142,122,143,29,0],[143,29,143,113,0],[143,113,145,29,0],[145,29,145,125,0],[145,125,146,29,0],[146,29,146,64,0],[146,64,148,29,0],[148,29,148,98,0],[148,98,150,29,0],[150,29,150,71,0],[150,71,151,29,0],[151,29,151,67,0],[151,67,152,29,0],[152,29,152,30,0],[152,30,153,33,0],[153,33,155,92,0],[155,92,156,29,0],[156,29,156,30,0],[156,30,158,29,0],[158,29,158,72,0],[158,72,159,29,0],[159,29,159,65,0],[159,65,160,29,0],[160,29,160,30,0],[160,30,161,33,0],[161,33,163,92,0],[163,92,164,29,0],[164,29,164,30,0],[164,30,166,29,0],[166,29,166,67,0],[166,67,167,29,0],[167,29,167,61,0],[167,61,168,29,0],[168,29,168,30,0],[168,30,169,33,0],[169,33,171,92,0],[171,92,172,29,0],[172,29,172,30,0],[172,30,174,29,0],[174,29,174,69,0],[174,69,175,29,0],[175,29,175,62,0],[175,62,176,29,0],[176,29,176,30,0],[176,30,177,33,0],[177,33,179,91,0],[179,91,180,29,0],[180,29,180,30,0],[180,30,182,29,0],[182,29,182,66,0],[182,66,183,29,0],[183,29,183,61,0],[183,61,184,29,0],[184,29,184,30,0],[184,30,185,33,0],[185,33,187,92,0],[187,92,188,29,0],[188,29,188,30,0],[188,30,189,25,0],[189,25,189,26,0],[189,26,190,23,0],[136,21,190,23,0],[190,23,191,17,0],[191,17,191,18,0],[191,18,191,20,0],[125,17,191,20,0],[192,13,192,14,0],[193,9,193,10,0],[196,9,196,10,0],[197,13,198,25,0],[198,25,198,26,0],[198,26,199,29,0],[199,29,199,60,0],[199,60,200,29,0],[200,29,200,74,0],[200,74,201,25,0],[201,25,201,26,0],[201,26,202,45,0],[197,13,202,45,0],[204,13,204,108,0],[206,13,206,35,0],[209,21,209,110,0],[210,21,210,27,0],[212,21,213,21,0],[213,21,213,22,0],[213,22,214,32,0],[214,32,214,101,0],[214,101,215,25,0],[215,25,215,26,0],[215,26,216,36,0],[216,36,216,118,0],[216,118,217,29,0],[217,29,217,30,0],[217,30,218,33,0],[218,33,220,59,0],[220,59,223,21,0],[223,21,223,22,0],[223,22,223,24,0],[212,21,223,24,0],[224,21,224,27,0],[226,21,226,89,0],[227,21,227,27,0],[230,13,230,100,0],[232,13,232,47,0],[233,13,233,14,0],[234,17,235,17,0],[235,17,235,18,0],[235,18,236,21,0],[236,21,236,54,0],[236,54,237,25,0],[237,25,237,62,0],[237,62,239,21,0],[239,21,239,38,0],[239,38,242,29,0],[242,29,242,67,0],[242,67,243,29,0],[243,29,243,35,0],[243,35,245,29,0],[245,29,245,113,0],[245,113,245,173,0],[245,173,245,175,0],[245,29,245,175,0],[245,175,246,29,0],[246,29,246,35,0],[246,35,248,29,0],[248,29,248,110,0],[248,110,248,167,0],[248,167,248,169,0],[248,29,248,169,0],[248,169,249,29,0],[249,29,249,35,0],[249,35,251,29,0],[251,29,251,109,0],[251,109,251,165,0],[251,165,251,167,0],[251,29,251,167,0],[251,167,252,29,0],[252,29,252,35,0],[252,35,254,17,0],[254,17,254,18,0],[254,18,254,20,0],[234,17,254,20,0],[255,13,255,14,0],[257,13,257,14,0],[258,17,258,49,0],[259,13,259,14,0],[260,9,260,10,0],[263,9,263,10,0],[265,13,265,34,0],[267,13,267,64,0],[268,13,269,28,0],[269,28,272,40,0],[272,40,276,36,0],[276,36,277,17,0],[277,17,277,18,0],[277,18,278,21,0],[278,21,278,73,0],[278,73,279,21,0],[279,21,279,130,0],[279,130,280,21,0],[280,21,280,76,0],[280,76,281,17,0],[281,17,281,18,0],[281,18,281,19,0],[276,36,281,19,0],[281,19,282,35,0],[282,35,283,17,0],[283,17,283,18,0],[283,18,284,21,0],[284,21,284,53,0],[284,53,285,21,0],[285,21,285,28,0],[285,28,285,30,0],[285,30,285,40,0],[285,40,285,41,0],[285,41,285,43,0],[285,43,285,44,0],[285,44,285,67,0],[285,67,286,21,0],[286,21,286,22,0],[286,22,287,25,0],[287,25,287,61,0],[287,61,288,21,0],[288,21,288,22,0],[288,22,289,21,0],[289,21,289,69,0],[289,69,290,17,0],[290,17,290,18,0],[290,18,290,19,0],[282,35,290,19,0],[290,19,292,17,0],[292,17,292,18,0],[292,18,293,21,0],[293,21,293,56,0],[293,56,294,17,0],[294,17,294,18,0],[294,18,296,17,0],[296,17,296,18,0],[296,18,297,21,0],[297,21,300,78,0],[300,78,301,17,0],[301,17,301,18,0],[301,18,302,30,0],[268,13,302,30,0],[303,9,303,10,0],[306,9,306,10,0],[307,13,307,112,0],[308,13,308,14,0],[309,17,309,38,0],[310,17,310,49,0],[311,17,311,44,0],[312,13,312,14,0],[314,13,314,14,0],[317,17,317,56,0],[318,13,318,14,0],[319,9,319,10,0]]);
    </script>
  </body>
</html>