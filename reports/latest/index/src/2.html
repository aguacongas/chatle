<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\chatle\src\chatle\Startup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Security.Claims;
using ChatLe.Models;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using System.IO;
using Microsoft.AspNetCore.Antiforgery;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Authentication.OAuth;
using Newtonsoft.Json.Linq;
using Microsoft.AspNetCore.Identity;
using ChatLe.Hubs;
using ChatLe.Cryptography;
using Google.Apis.Auth.OAuth2;
using Newtonsoft.Json;

namespace ChatLe
{
    public class Startup
    {
        enum DBEngine
        {
            SqlServer,
            InMemory,
            Redis,
            SQLite,
            MySql,
            Firebase
        }

        readonly IHostingEnvironment _environment;
        public ILoggerFactory LoggerFactory { get; private set; }
        public Startup(IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            var builder = new ConfigurationBuilder()
                .SetBasePath(env.ContentRootPath)
                .AddJsonFile(&quot;config.json&quot;)
                .AddJsonFile($&quot;config.{env.EnvironmentName}.json&quot;, optional: true);

            if (env.IsDevelopment())
            {
                // For more details on using the user secret store see http://go.microsoft.com/fwlink/?LinkID=532709
                builder.AddUserSecrets&lt;Startup&gt;();
                loggerFactory.AddDebug();
            }

            builder.AddEnvironmentVariables();

            Configuration = builder.Build();

            _environment = env;
            LoggerFactory = loggerFactory;
            loggerFactory.AddAzureWebAppDiagnostics();

            loggerFactory.AddConsole();
        }

        public IConfiguration Configuration { get; private set; }

        public virtual void ConfigureServices(IServiceCollection services)
        {
            services.AddChatLe(options =&gt; options.UserPerPage = int.Parse(Configuration[&quot;ChatConfig:UserPerPage&quot;]))
                .AddCors()
                .AddAntiforgery(options =&gt; options.HeaderName = &quot;X-XSRF-TOKEN&quot;);

            ConfigureEntity(services);

            services.AddMvc()
                .AddJsonOptions(options =&gt;
                {
                    options.SerializerSettings.NullValueHandling = NullValueHandling.Ignore;
                });

            services.AddSignalR();

            var authServices = services.AddAuthentication();
            if (Configuration[&quot;Authentication:Facebook:AppId&quot;] != null)
            { 
                authServices.AddFacebook(facebookOptions =&gt;
                {
                    facebookOptions.AppId = Configuration[&quot;Authentication:Facebook:AppId&quot;];
                    facebookOptions.AppSecret = Configuration[&quot;Authentication:Facebook:AppSecret&quot;];
                    facebookOptions.SaveTokens = true;
                });
            }

            if (Configuration[&quot;Authentication:Twitter:ConsumerKey&quot;] != null)
            {
                authServices.AddTwitter(twitterOptions =&gt;
                {
                    twitterOptions.ConsumerKey = Configuration[&quot;Authentication:Twitter:ConsumerKey&quot;];
                    twitterOptions.ConsumerSecret = Configuration[&quot;Authentication:Twitter:ConsumerSecret&quot;];
                    twitterOptions.SaveTokens = true;

                });
            }
            if (Configuration[&quot;Authentication:Google:ClientId&quot;] != null)
            {
                authServices.AddGoogle(googleOption =&gt;
                {
                    googleOption.ClientId = Configuration[&quot;Authentication:Google:ClientId&quot;];
                    googleOption.ClientSecret = Configuration[&quot;Authentication:Google:ClientSecret&quot;];
                    googleOption.SaveTokens = true;
                });
            }
            if (Configuration[&quot;Authentication:MicrosoftAccount:ClientId&quot;] != null)
            {
                authServices.AddMicrosoftAccount(microsoftAccountOptions =&gt;
                {
                    microsoftAccountOptions.ClientId = Configuration[&quot;Authentication:MicrosoftAccount:ClientId&quot;];
                    microsoftAccountOptions.ClientSecret = Configuration[&quot;Authentication:MicrosoftAccount:ClientSecret&quot;];
                    microsoftAccountOptions.SaveTokens = true;
                });
            }
            if (Configuration[&quot;Authentication:Github:ClientId&quot;] != null)
            {
                authServices.AddOAuth(&quot;Github&quot;, options =&gt;
                {
                    options.ClientId = Configuration[&quot;Authentication:Github:ClientId&quot;];
                    options.ClientSecret = Configuration[&quot;Authentication:Github:ClientSecret&quot;];
                    options.CallbackPath = new PathString(&quot;/signin-github&quot;);
                    options.AuthorizationEndpoint = &quot;https://github.com/login/oauth/authorize&quot;;
                    options.TokenEndpoint = &quot;https://github.com/login/oauth/access_token&quot;;
                    options.UserInformationEndpoint = &quot;https://api.github.com/user&quot;;
                    options.ClaimsIssuer = &quot;OAuth2-Github&quot;;
                    options.SaveTokens = true;
                    // Retrieving user information is unique to each provider.
                    options.Events = new OAuthEvents
                    {
                        OnCreatingTicket = async context =&gt;
                        {
                            // Get the GitHub user
                            var request = new HttpRequestMessage(HttpMethod.Get, context.Options.UserInformationEndpoint);
                            request.Headers.Authorization = new AuthenticationHeaderValue(&quot;Bearer&quot;, context.AccessToken);
                            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue(&quot;application/json&quot;));

                            var response = await context.Backchannel.SendAsync(request, context.HttpContext.RequestAborted);
                            response.EnsureSuccessStatusCode();

                            var user = JObject.Parse(await response.Content.ReadAsStringAsync());

                            var identifier = user.Value&lt;string&gt;(&quot;id&quot;);
                            if (!string.IsNullOrEmpty(identifier))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimTypes.NameIdentifier, identifier,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var userName = user.Value&lt;string&gt;(&quot;login&quot;);
                            if (!string.IsNullOrEmpty(userName))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimsIdentity.DefaultNameClaimType, userName,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var name = user.Value&lt;string&gt;(&quot;name&quot;);
                            if (!string.IsNullOrEmpty(name))
                            {
                                context.Identity.AddClaim(new Claim(
                                    &quot;urn:github:name&quot;, name,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }

                            var email = user.Value&lt;string&gt;(&quot;email&quot;);
                            if (!string.IsNullOrEmpty(email))
                            {
                                context.Identity.AddClaim(new Claim(
                                    ClaimTypes.Email, email,
                                    ClaimValueTypes.Email, context.Options.ClaimsIssuer));
                            }

                            var link = user.Value&lt;string&gt;(&quot;url&quot;);
                            if (!string.IsNullOrEmpty(link))
                            {
                                context.Identity.AddClaim(new Claim(
                                    &quot;urn:github:url&quot;, link,
                                    ClaimValueTypes.String, context.Options.ClaimsIssuer));
                            }
                        }
                    };
                });
            }
        }

        private void ConfigureEntity(IServiceCollection services)
        {
            var identyBuilder = services.AddIdentity&lt;ChatLeUser, IdentityRole&gt;(options =&gt;
                        {
                            var userOptions = options.User;
                            userOptions.AllowedUserNameCharacters += &quot; &quot;;
                        })
                .AddDefaultTokenProviders();

            var dbEngine = (DBEngine)Enum.Parse(typeof(DBEngine), Configuration[&quot;DatabaseEngine&quot;]);
            if (dbEngine != DBEngine.Firebase)
            {
                identyBuilder.AddEntityFrameworkStores&lt;ChatLeIdentityDbContext&gt;();

                services.AddDbContext&lt;ChatLeIdentityDbContext&gt;(options =&gt;
                {
                    if (_environment.IsDevelopment())
                        options.EnableSensitiveDataLogging();

                    switch (dbEngine)
                    {
                        case DBEngine.InMemory:
                            options.UseInMemoryDatabase(&quot;chatle&quot;);
                            break;
                        case DBEngine.SqlServer:
                            options.UseSqlServer(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.SqlServer&quot;));
                            break;
                        case DBEngine.SQLite:
                            options.UseSqlite(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.Sqlite&quot;));
                            break;
                        case DBEngine.MySql:
                            options.UseMySql(Configuration[&quot;Data:DefaultConnection:ConnectionString&quot;], o =&gt; o.MigrationsAssembly(&quot;ChatLe.Repository.Identity.MySql&quot;));
                            break;
                        //case DBEngine.Redis:
                        //    int port;
                        //    int database;
                        //    if (!int.TryParse(Configuration[&quot;Data:Redis:Port&quot;], out port))
                        //        port = 6379;
                        //    int.TryParse(Configuration[&quot;Data:Redis:Database&quot;], out database);

                        //    options.UseRedisDatabase(Configuration[&quot;Data:Redis:Hostname&quot;], port, database);
                        //    break;
                }
                });
            }
            else
            {
                identyBuilder.AddFirebaseStores(Configuration[&quot;FirebaseOptions:DatabaseUrl&quot;], provider =&gt;
                {
                    using (var utility = new Utility(Configuration[&quot;FirebaseOptions:SecureKey&quot;]))
                    {
                        using (var stream = utility.DecryptFile(&quot;firebase-key.json.enc&quot;).GetAwaiter().GetResult())
                        {
                            return GoogleCredential.FromStream(stream)
                                .CreateScoped(&quot;https://www.googleapis.com/auth/userinfo.email&quot;, &quot;https://www.googleapis.com/auth/firebase.database&quot;)
                                .UnderlyingCredential;
                        }
                    }
                });

                services.AddFirebaseChatStore();
            }
        }

        public virtual void Configure(IApplicationBuilder app, IAntiforgery antiforgery)
        {

            ConfigureErrors(app);

            var logger = LoggerFactory.CreateLogger(&quot;request&quot;);
            app.UseCors(
                builder =&gt; builder.AllowAnyOrigin()
                    .AllowAnyHeader()
                    .AllowAnyMethod()
                    .AllowCredentials())
                .UseStaticFiles()
                .UseWebSockets()
                .UseAuthentication()
                .Map(&quot;/xhrf&quot;, a =&gt; a.Run(async context =&gt;
                {
                    var tokens = antiforgery.GetAndStoreTokens(context);
                    context.Response.Cookies.Append(&quot;XSRF-TOKEN&quot;, tokens.RequestToken, new CookieOptions() { HttpOnly = false });
                    await context.Response.WriteAsync(tokens.RequestToken);
                }))
                .Map(&quot;/cls&quot;, a =&gt; a.Run(async context =&gt;
                {
                    var response = context.Response;
                    foreach (var cookie in context.Request.Cookies)
                    {
                        response.Cookies.Delete(cookie.Key);
                    }
                    await context.Response.WriteAsync(string.Empty);
                }))
                .UseSignalR(configure =&gt;
                {
                    configure.MapHub&lt;ChatHub&gt;(&quot;/chat&quot;);
                })
                .UseMvc(routes =&gt;
                {
                    routes.MapRoute(
                    name: &quot;default&quot;,
                    template: &quot;{controller}/{action}/{id?}&quot;,
                    defaults: new { controller = &quot;Home&quot;, action = &quot;Index&quot; });
                })
                .UseChatLe();
        }

        protected virtual void ConfigureErrors(IApplicationBuilder app)
        {
            if (string.Equals(_environment.EnvironmentName, &quot;Development&quot;, StringComparison.OrdinalIgnoreCase))
            {
                app.UseBrowserLink();
                app.UseDeveloperExceptionPage();
                app.UseDatabaseErrorPage();
            }
            else
            {
                // Add Error handling middleware which catches all application specific errors and
                // send the request to the following path or controller action.
                app.UseExceptionHandler(&quot;/Home/Error&quot;);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[38,47,38,51,0],[38,52,38,64,0],[39,9,39,78,0],[40,9,40,10,0],[41,13,44,84,0],[46,13,46,37,0],[47,13,47,14,0],[49,17,49,51,0],[50,17,50,42,0],[51,13,51,14,0],[53,13,53,47,0],[55,13,55,45,0],[57,13,57,32,0],[58,13,58,43,0],[59,13,59,55,0],[61,13,61,40,0],[62,9,62,10,0],[64,47,64,51,0],[64,52,64,64,0],[67,9,67,10,0],[68,13,68,43,0],[68,43,68,115,0],[68,115,70,44,0],[70,44,70,79,0],[70,79,70,81,0],[68,13,70,81,0],[72,13,72,39,0],[74,13,76,17,0],[76,17,76,18,0],[76,18,77,21,0],[77,21,77,93,0],[77,93,78,17,0],[78,17,78,18,0],[78,18,78,20,0],[74,13,78,20,0],[80,13,80,35,0],[82,13,82,61,0],[83,13,83,72,0],[84,13,84,14,0],[85,17,86,17,0],[86,17,86,18,0],[86,18,87,21,0],[87,21,87,92,0],[87,92,88,21,0],[88,21,88,100,0],[88,100,89,21,0],[89,21,89,55,0],[89,55,90,17,0],[90,17,90,18,0],[90,18,90,20,0],[85,17,90,20,0],[91,13,91,14,0],[93,13,93,77,0],[94,13,94,14,0],[95,17,96,17,0],[96,17,96,18,0],[96,18,97,21,0],[97,21,97,102,0],[97,102,98,21,0],[98,21,98,108,0],[98,108,99,21,0],[99,21,99,54,0],[99,54,101,17,0],[101,17,101,18,0],[101,18,101,20,0],[95,17,101,20,0],[102,13,102,14,0],[103,13,103,73,0],[104,13,104,14,0],[105,17,106,17,0],[106,17,106,18,0],[106,18,107,21,0],[107,21,107,93,0],[107,93,108,21,0],[108,21,108,101,0],[108,101,109,21,0],[109,21,109,52,0],[109,52,110,17,0],[110,17,110,18,0],[110,18,110,20,0],[105,17,110,20,0],[111,13,111,14,0],[112,13,112,83,0],[113,13,113,14,0],[114,17,115,17,0],[115,17,115,18,0],[115,18,116,21,0],[116,21,116,114,0],[116,114,117,21,0],[117,21,117,122,0],[117,122,118,21,0],[118,21,118,63,0],[118,63,119,17,0],[119,17,119,18,0],[119,18,119,20,0],[114,17,119,20,0],[120,13,120,14,0],[121,13,121,73,0],[122,13,122,14,0],[123,17,124,17,0],[124,17,124,18,0],[124,18,125,21,0],[125,21,125,88,0],[125,88,126,21,0],[126,21,126,96,0],[126,96,127,21,0],[127,21,127,77,0],[127,77,128,21,0],[128,21,128,96,0],[128,96,129,21,0],[129,21,129,91,0],[129,91,130,21,0],[130,21,130,85,0],[130,85,131,21,0],[131,21,131,60,0],[131,60,132,21,0],[132,21,132,47,0],[132,47,134,21,0],[134,21,137,25,0],[137,25,137,26,0],[137,26,139,29,0],[139,29,139,123,0],[139,123,140,29,0],[140,29,140,122,0],[140,122,141,29,0],[141,29,141,113,0],[141,113,143,29,0],[143,29,143,125,0],[143,125,144,29,0],[144,29,144,64,0],[144,64,146,29,0],[146,29,146,98,0],[146,98,148,29,0],[148,29,148,71,0],[148,71,149,29,0],[149,29,149,67,0],[149,67,150,29,0],[150,29,150,30,0],[150,30,151,33,0],[151,33,153,92,0],[153,92,154,29,0],[154,29,154,30,0],[154,30,156,29,0],[156,29,156,72,0],[156,72,157,29,0],[157,29,157,65,0],[157,65,158,29,0],[158,29,158,30,0],[158,30,159,33,0],[159,33,161,92,0],[161,92,162,29,0],[162,29,162,30,0],[162,30,164,29,0],[164,29,164,67,0],[164,67,165,29,0],[165,29,165,61,0],[165,61,166,29,0],[166,29,166,30,0],[166,30,167,33,0],[167,33,169,92,0],[169,92,170,29,0],[170,29,170,30,0],[170,30,172,29,0],[172,29,172,69,0],[172,69,173,29,0],[173,29,173,62,0],[173,62,174,29,0],[174,29,174,30,0],[174,30,175,33,0],[175,33,177,91,0],[177,91,178,29,0],[178,29,178,30,0],[178,30,180,29,0],[180,29,180,66,0],[180,66,181,29,0],[181,29,181,61,0],[181,61,182,29,0],[182,29,182,30,0],[182,30,183,33,0],[183,33,185,92,0],[185,92,186,29,0],[186,29,186,30,0],[186,30,187,25,0],[187,25,187,26,0],[187,26,188,23,0],[134,21,188,23,0],[188,23,189,17,0],[189,17,189,18,0],[189,18,189,20,0],[123,17,189,20,0],[190,13,190,14,0],[191,9,191,10,0],[194,9,194,10,0],[195,13,196,25,0],[196,25,196,26,0],[196,26,197,29,0],[197,29,197,60,0],[197,60,198,29,0],[198,29,198,74,0],[198,74,199,25,0],[199,25,199,26,0],[199,26,200,45,0],[195,13,200,45,0],[202,13,202,100,0],[203,13,203,47,0],[204,13,204,14,0],[205,17,205,83,0],[207,17,208,17,0],[208,17,208,18,0],[208,18,209,21,0],[209,21,209,54,0],[209,54,210,25,0],[210,25,210,62,0],[210,62,212,21,0],[212,21,212,38,0],[212,38,215,29,0],[215,29,215,67,0],[215,67,216,29,0],[216,29,216,35,0],[216,35,218,29,0],[218,29,218,113,0],[218,113,218,173,0],[218,173,218,175,0],[218,29,218,175,0],[218,175,219,29,0],[219,29,219,35,0],[219,35,221,29,0],[221,29,221,110,0],[221,110,221,167,0],[221,167,221,169,0],[221,29,221,169,0],[221,169,222,29,0],[222,29,222,35,0],[222,35,224,29,0],[224,29,224,109,0],[224,109,224,165,0],[224,165,224,167,0],[224,29,224,167,0],[224,167,225,29,0],[225,29,225,35,0],[225,35,236,17,0],[236,17,236,18,0],[236,18,236,20,0],[207,17,236,20,0],[237,13,237,14,0],[239,13,239,14,0],[240,17,241,17,0],[241,17,241,18,0],[241,18,242,28,0],[242,28,242,97,0],[242,97,243,21,0],[243,21,243,22,0],[243,22,244,32,0],[244,32,244,114,0],[244,114,245,25,0],[245,25,245,26,0],[245,26,246,29,0],[246,29,248,55,0],[248,55,251,17,0],[251,17,251,18,0],[251,18,251,20,0],[240,17,251,20,0],[253,17,253,49,0],[254,13,254,14,0],[255,9,255,10,0],[258,9,258,10,0],[260,13,260,34,0],[262,13,262,64,0],[263,13,264,28,0],[264,28,267,40,0],[267,40,271,36,0],[271,36,272,17,0],[272,17,272,18,0],[272,18,273,21,0],[273,21,273,73,0],[273,73,274,21,0],[274,21,274,130,0],[274,130,275,21,0],[275,21,275,76,0],[275,76,276,17,0],[276,17,276,18,0],[276,18,276,19,0],[271,36,276,19,0],[276,19,277,35,0],[277,35,278,17,0],[278,17,278,18,0],[278,18,279,21,0],[279,21,279,53,0],[279,53,280,21,0],[280,21,280,28,0],[280,28,280,30,0],[280,30,280,40,0],[280,40,280,41,0],[280,41,280,43,0],[280,43,280,44,0],[280,44,280,67,0],[280,67,281,21,0],[281,21,281,22,0],[281,22,282,25,0],[282,25,282,61,0],[282,61,283,21,0],[283,21,283,22,0],[283,22,284,21,0],[284,21,284,69,0],[284,69,285,17,0],[285,17,285,18,0],[285,18,285,19,0],[277,35,285,19,0],[285,19,287,17,0],[287,17,287,18,0],[287,18,288,21,0],[288,21,288,56,0],[288,56,289,17,0],[289,17,289,18,0],[289,18,291,17,0],[291,17,291,18,0],[291,18,292,21,0],[292,21,295,78,0],[295,78,296,17,0],[296,17,296,18,0],[296,18,297,30,0],[263,13,297,30,0],[298,9,298,10,0],[301,9,301,10,0],[302,13,302,112,0],[303,13,303,14,0],[304,17,304,38,0],[305,17,305,49,0],[306,17,306,44,0],[307,13,307,14,0],[309,13,309,14,0],[312,17,312,56,0],[313,13,313,14,0],[314,9,314,10,0]]);
    </script>
  </body>
</html>