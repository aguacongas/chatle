<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\chatle\test\chatle.test\Controllers\AccountControllerTest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ChatLe.Controllers;
using ChatLe.Models;
using Microsoft.AspNetCore.Identity;
using System;
using Moq;
using Xunit;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Options;
using System.Threading;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc.ViewFeatures;
using Microsoft.Extensions.Logging;
using System.Security.Claims;
using ChatLe.Hubs;
using Microsoft.AspNetCore.SignalR;
using System.Dynamic;
using ChatLe.ViewModels;
using Microsoft.Extensions.DependencyInjection;
using ChatLe.Repository.Identity;
using System.Security.Principal;
using Microsoft.AspNetCore.Http.Authentication;
using Microsoft.AspNetCore.Authentication;

namespace Chatle.test.Controllers
{
    public class TestRole
    {
        public string Id { get; private set; }
        public string Name { get; set; }
    }

    public interface ITestUserStore&lt;T&gt; : IUserStore&lt;T&gt;, IUserPasswordStore&lt;T&gt; where T : class
    { }

    public class AccountControllerTest
    {
        private static UserManager&lt;TUser&gt; GetUserManager&lt;TUser&gt;(List&lt;IUserValidator&lt;TUser&gt;&gt; userValidators) where TUser : class
        {
            var store = new Mock&lt;ITestUserStore&lt;TUser&gt;&gt;();
            store.Setup(s =&gt; s.CreateAsync(It.IsAny&lt;TUser&gt;(), It.IsAny&lt;CancellationToken&gt;())).ReturnsAsync(IdentityResult.Success);
            var options = new Mock&lt;IOptions&lt;IdentityOptions&gt;&gt;();
            var idOptions = new IdentityOptions();
            idOptions.Lockout.AllowedForNewUsers = false;
            options.Setup(o =&gt; o.Value).Returns(idOptions);
            var pwdValidators = new List&lt;PasswordValidator&lt;TUser&gt;&gt;();
            pwdValidators.Add(new PasswordValidator&lt;TUser&gt;());
            var userManager = new UserManager&lt;TUser&gt;(store.Object, options.Object, new PasswordHasher&lt;TUser&gt;(),
                userValidators, pwdValidators, new UpperInvariantLookupNormalizer(),
                new IdentityErrorDescriber(), null,
                new Mock&lt;ILogger&lt;UserManager&lt;TUser&gt;&gt;&gt;().Object);

            return userManager;
        }

        private static Mock&lt;UserManager&lt;TUser&gt;&gt; MockUserManager&lt;TUser&gt;(List&lt;IUserValidator&lt;TUser&gt;&gt; userValidators) where TUser : class
        {
            var store = new Mock&lt;ITestUserStore&lt;TUser&gt;&gt;();
            var options = new Mock&lt;IOptions&lt;IdentityOptions&gt;&gt;();
            var idOptions = new IdentityOptions();
            idOptions.Lockout.AllowedForNewUsers = false;
            options.Setup(o =&gt; o.Value).Returns(idOptions);
            var pwdValidators = new List&lt;PasswordValidator&lt;TUser&gt;&gt;();
            pwdValidators.Add(new PasswordValidator&lt;TUser&gt;());

            var services = new ServiceCollection();
            services.AddEntityFrameworkInMemoryDatabase();

            var userManager = new Mock&lt;UserManager&lt;TUser&gt;&gt;(store.Object, options.Object, new PasswordHasher&lt;TUser&gt;(),
                userValidators, pwdValidators, new UpperInvariantLookupNormalizer(),
                new IdentityErrorDescriber(), services.BuildServiceProvider(),
                new Mock&lt;ILogger&lt;UserManager&lt;TUser&gt;&gt;&gt;().Object);

            return userManager;
        }


        private static Mock&lt;SignInManager&gt; MockSigninManager&lt;TUser&gt;(UserManager&lt;TUser&gt; userManager) where TUser : class
        {
            var context = new Mock&lt;HttpContext&gt;();
            var contextAccessor = new Mock&lt;IHttpContextAccessor&gt;();
            contextAccessor.Setup(a =&gt; a.HttpContext).Returns(context.Object);

            var roleManager = new RoleManager&lt;TestRole&gt;(new Mock&lt;IRoleStore&lt;TestRole&gt;&gt;().Object, new RoleValidator&lt;TestRole&gt;[] { new RoleValidator&lt;TestRole&gt;() }, null, null, null);
            var identityOptions = new IdentityOptions();
            var options = new Mock&lt;IOptions&lt;IdentityOptions&gt;&gt;();
            options.Setup(a =&gt; a.Value).Returns(identityOptions);
            var claimsFactory = new UserClaimsPrincipalFactory&lt;TUser, TestRole&gt;(userManager, roleManager, options.Object);
            return new Mock&lt;SignInManager&gt;(userManager, contextAccessor.Object, claimsFactory, options.Object, null, null);
        }


        [Fact]
        public async Task RegisterTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = GetUserManager(userValidators);

            validator.Setup(v =&gt; v.ValidateAsync(userManager, It.IsAny&lt;ChatLeUser&gt;()))
               .Returns(Task.FromResult(IdentityResult.Success)).Verifiable();

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager);
            signinManager.Setup(m =&gt; m.SignInAsync(It.IsAny&lt;ChatLeUser&gt;(), It.IsAny&lt;bool&gt;(), null)).Returns(Task.FromResult(0)).Verifiable();
            var chatManager = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;().Object;
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

            var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();
            using (var controller = new AccountController(userManager, signinManager.Object, chatManager, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                var result = await controller.Register(new RegisterViewModel()
                {
                    ConfirmPassword = &quot;test123&quot;,
                    Password = &quot;Test123-123&quot;,
                    UserName = &quot;test&quot;
                });

                Assert.IsType&lt;RedirectToActionResult&gt;(result);
            }
        }

        [Fact]
        public async Task RegisterFailedTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManagerMock = MockUserManager(userValidators);
            userManagerMock.Setup(u =&gt; u.CreateAsync(It.IsAny&lt;ChatLeUser&gt;(), It.IsAny&lt;string&gt;()))
                .ReturnsAsync(IdentityResult.Failed(new IdentityError()
                {
                    Code = &quot;test&quot;,
                    Description = &quot;test&quot;
                }));
            var userManager = userManagerMock.Object; ;

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager);
            var metaDataProvider = new Mock&lt;IModelMetadataProvider&gt;().Object;
            var chatManager = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;().Object;
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

            var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(userManager, signinManager.Object, chatManager, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                var result = await controller.Register(new RegisterViewModel()
                {
                    ConfirmPassword = &quot;test123&quot;,
                    Password = &quot;test123&quot;,
                    UserName = &quot;test&quot;
                });

                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public void GetRegisterTest()
        {
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

			var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(null, null, null, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                var result = controller.Register();
                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public void IndexTest()
        {
            var mockCookies = new Mock&lt;IResponseCookies&gt;();
            var mockHttpResponse = new Mock&lt;HttpResponse&gt;();
            mockHttpResponse.SetupGet(r =&gt; r.Cookies)
                .Returns(mockCookies.Object);
            var mockHttpContext = new Mock&lt;HttpContext&gt;();
            mockHttpContext.SetupGet(c =&gt; c.Response)
                .Returns(mockHttpResponse.Object);

            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

			var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(null, null, null, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                controller.ControllerContext.HttpContext = mockHttpContext.Object;

                var result = controller.Index();
                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public async Task LoginTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = GetUserManager(userValidators);

            validator.Setup(v =&gt; v.ValidateAsync(userManager, It.IsAny&lt;ChatLeUser&gt;()))
               .Returns(Task.FromResult(IdentityResult.Success)).Verifiable();

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager);
            signinManager.Setup(m =&gt; m.PasswordSignInAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;bool&gt;(), It.IsAny&lt;bool&gt;())).Returns(Task.FromResult(Microsoft.AspNetCore.Identity.SignInResult.Success));
            var chatManager = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;().Object;
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

            var loginViewModel = new LoginViewModel()
            {
                Password = &quot;test&quot;,
                RememberMe = true,
                UserName = &quot;test&quot;
            };

            var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(userManager, signinManager.Object, chatManager, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                controller.Url = new Mock&lt;IUrlHelper&gt;().Object;
                var result = await controller.Login(loginViewModel, null);
                Assert.IsType&lt;RedirectToActionResult&gt;(result);

                signinManager.Setup(m =&gt; m.PasswordSignInAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;bool&gt;(), It.IsAny&lt;bool&gt;())).Returns(Task.FromResult(Microsoft.AspNetCore.Identity.SignInResult.Failed));

                result = await controller.Login(loginViewModel);


                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public async Task GuessTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = MockUserManager&lt;ChatLeUser&gt;(userValidators);
            userManager.Setup(u =&gt; u.CreateAsync(It.IsAny&lt;ChatLeUser&gt;())).ReturnsAsync(IdentityResult.Success);
            validator.Setup(v =&gt; v.ValidateAsync(userManager.Object, It.IsAny&lt;ChatLeUser&gt;()))
               .Returns(Task.FromResult(IdentityResult.Success)).Verifiable();

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager.Object);
            var chatManager = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;().Object;
            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

            var guessViewModel = new GuessViewModel()
            {
                UserName = &quot;test&quot;
            };

            var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(userManager.Object, signinManager.Object, chatManager, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                var result = await controller.Guess(guessViewModel);
                Assert.IsType&lt;RedirectToActionResult&gt;(result);

                userManager.Setup(u =&gt; u.CreateAsync(It.IsAny&lt;ChatLeUser&gt;())).ReturnsAsync(IdentityResult.Failed());

                result = await controller.Guess(guessViewModel);
                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public async Task GetManageTest()
        {
            var storeMock = new Mock&lt;IChatStore&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            storeMock.Setup(s =&gt; s.FindUserByNameAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;CancellationToken&gt;()))
                .ReturnsAsync(new ChatLeUser());

            var chatManagerMock = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            chatManagerMock.SetupGet(c =&gt; c.Store)
                .Returns(storeMock.Object);

            var mockCookies = new Mock&lt;IResponseCookies&gt;();
            var mockHttpResponse = new Mock&lt;HttpResponse&gt;();
            mockHttpResponse.SetupGet(r =&gt; r.Cookies)
                .Returns(mockCookies.Object);

            var mockHttpContext = new Mock&lt;HttpContext&gt;();
            mockHttpContext.SetupGet(c =&gt; c.User)
                .Returns(new ClaimsPrincipal(new Mock&lt;IIdentity&gt;().Object));
            mockHttpContext.SetupGet(c =&gt; c.Response)
                .Returns(mockHttpResponse.Object);

            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = MockUserManager&lt;ChatLeUser&gt;(userValidators);
            userManager.Setup(u =&gt; u.GetLoginsAsync(It.IsAny&lt;ChatLeUser&gt;()))
                .ReturnsAsync(new List&lt;UserLoginInfo&gt;());

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager.Object);
            signinManager.Setup(s =&gt; s.GetExternalAuthenticationSchemesAsync())
                .ReturnsAsync(new List&lt;AuthenticationScheme&gt;());

            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

			var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(userManager.Object, signinManager.Object, chatManagerMock.Object, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                controller.ControllerContext.HttpContext = mockHttpContext.Object;

                controller.Url = new Mock&lt;IUrlHelper&gt;().Object;
                var result = await controller.Manage();
                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }

        [Fact]
        public async Task ManageTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = MockUserManager&lt;ChatLeUser&gt;(userValidators);
            userManager.Setup(u =&gt; u.ChangePasswordAsync(It.IsAny&lt;ChatLeUser&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;())).ReturnsAsync(IdentityResult.Success);
            validator.Setup(v =&gt; v.ValidateAsync(userManager.Object, It.IsAny&lt;ChatLeUser&gt;()))
               .Returns(Task.FromResult(IdentityResult.Success)).Verifiable();

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager.Object);
            var storeMock = new Mock&lt;IChatStore&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            storeMock.Setup(s =&gt; s.FindUserByNameAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;CancellationToken&gt;()))
               .ReturnsAsync(new ChatLeUser());

            var chatManagerMock = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            chatManagerMock.SetupGet(c =&gt; c.Store)
                .Returns(storeMock.Object);

            var mockHttpContext = new Mock&lt;HttpContext&gt;();
            mockHttpContext.SetupGet(c =&gt; c.User)
                .Returns(new ClaimsPrincipal(new Mock&lt;IIdentity&gt;().Object));

            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());

            var manageViewModel = new UpdatePasswordViewModel()
            {
                ConfirmPassword = &quot;test&quot;,
                NewPassword = &quot;test&quot;,
                OldPassword = &quot;test&quot;
            };

			var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();

            using (var controller = new AccountController(userManager.Object, signinManager.Object, chatManagerMock.Object, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                controller.Url = new Mock&lt;IUrlHelper&gt;().Object;
                controller.ControllerContext.HttpContext = mockHttpContext.Object;

                var result = await controller.UpdatePassword(manageViewModel);
                Assert.IsType&lt;RedirectToActionResult&gt;(result);

                userManager.Setup(u =&gt; u.ChangePasswordAsync(It.IsAny&lt;ChatLeUser&gt;(), It.IsAny&lt;string&gt;(), It.IsAny&lt;string&gt;())).ReturnsAsync(IdentityResult.Failed());

                result = await controller.UpdatePassword(manageViewModel);
                Assert.IsType&lt;ViewResult&gt;(result);
            }
        }


        [Fact]
        public async Task LogOffTest()
        {
            var userValidators = new List&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            var validator = new Mock&lt;IUserValidator&lt;ChatLeUser&gt;&gt;();
            userValidators.Add(validator.Object);
            var userManager = MockUserManager&lt;ChatLeUser&gt;(userValidators);

            var signinManager = MockSigninManager&lt;ChatLeUser&gt;(userManager.Object);

            var storeMock = new Mock&lt;IChatStore&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            storeMock.Setup(s =&gt; s.FindUserByNameAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;CancellationToken&gt;()))
                .ReturnsAsync(new ChatLeUser());

            var chatManagerMock = new Mock&lt;IChatManager&lt;string, ChatLeUser, Conversation, Attendee, Message, NotificationConnection&gt;&gt;();
            chatManagerMock.SetupGet(c =&gt; c.Store)
                .Returns(storeMock.Object);

            var mockHttpContext = new Mock&lt;HttpContext&gt;();
            mockHttpContext.SetupGet(c =&gt; c.User)
                .Returns(new ClaimsPrincipal(new Mock&lt;IIdentity&gt;().Object));

            var viewData = new ViewDataDictionary(new EmptyModelMetadataProvider(), new ModelStateDictionary());
            var mockHubContext = new Mock&lt;IHubContext&lt;ChatHub&gt;&gt;();
            var clientsMock = new Mock&lt;IHubClients&gt;();
            clientsMock.SetupGet(c =&gt; c.All).Returns(new Mock&lt;IClientProxy&gt;().Object);
            mockHubContext.SetupGet(h =&gt; h.Clients).Returns(clientsMock.Object);

			var mockLogger = new Mock&lt;ILogger&gt;();
            var mockLoggerFactory = new Mock&lt;ILoggerFactory&gt;();
            mockLoggerFactory.Setup(m =&gt; m.CreateLogger(It.IsAny&lt;string&gt;()))
                .Returns(mockLogger.Object);

            using (var controller = new AccountController(userManager.Object, signinManager.Object, chatManagerMock.Object, mockHubContext.Object, mockLoggerFactory.Object) { ViewData = viewData })
            {
                controller.Url = new Mock&lt;IUrlHelper&gt;().Object;

                controller.ControllerContext.HttpContext = mockHttpContext.Object;

                var result = await controller.LogOff();
                Assert.IsType&lt;RedirectToActionResult&gt;(result);

                storeMock.Setup(s =&gt; s.FindUserByNameAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;CancellationToken&gt;()))
                    .ReturnsAsync(new ChatLeUser { PasswordHash = &quot;test&quot; });

                result = await controller.LogOff();
                Assert.IsType&lt;RedirectToActionResult&gt;(result);

                storeMock.Setup(s =&gt; s.FindUserByNameAsync(It.IsAny&lt;string&gt;(), It.IsAny&lt;CancellationToken&gt;()))
                    .ReturnsAsync(() =&gt; null);

                result = await controller.LogOff();
                Assert.IsType&lt;RedirectToActionResult&gt;(result);
            }
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,28,32,32,0],[32,33,32,45,0],[33,30,33,34,0],[33,35,33,39,0],[42,9,42,10,1],[43,13,43,59,1],[44,13,44,132,1],[45,13,45,65,1],[46,13,46,51,1],[47,13,47,58,1],[48,13,48,60,1],[49,13,49,70,1],[50,13,50,63,1],[51,13,54,65,1],[56,13,56,32,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,59,1],[62,13,62,65,1],[63,13,63,51,1],[64,13,64,58,1],[65,13,65,60,1],[66,13,66,70,1],[67,13,67,63,1],[69,13,69,52,1],[70,13,70,59,1],[72,13,75,65,1],[77,13,77,32,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,51,1],[84,13,84,68,1],[85,13,85,79,1],[87,13,87,181,1],[88,13,88,57,1],[89,13,89,65,1],[90,13,90,66,1],[91,13,91,123,1],[92,13,92,124,1],[93,9,93,10,1],[98,9,98,10,1],[99,13,99,73,1],[100,13,100,68,1],[101,13,101,50,1],[102,13,102,62,1],[104,13,105,79,1],[107,13,107,76,1],[108,13,108,142,1],[109,13,109,140,1],[110,13,110,113,1],[112,13,112,50,1],[113,13,113,64,1],[114,13,115,45,1],[116,13,116,67,1],[117,20,117,179,1],[118,13,118,14,1],[119,17,124,20,1],[126,17,126,63,1],[127,13,127,14,1],[128,9,128,10,1],[132,9,132,10,1],[133,13,133,73,1],[134,13,134,68,1],[135,13,135,50,1],[136,13,136,67,1],[137,13,142,21,1],[143,13,143,54,1],[143,55,143,56,1],[145,13,145,76,1],[146,13,146,78,1],[147,13,147,140,1],[148,13,148,113,1],[150,13,150,50,1],[151,13,151,64,1],[152,13,153,45,1],[154,13,154,67,1],[156,20,156,179,1],[157,13,157,14,1],[158,17,163,20,1],[165,17,165,51,1],[166,13,166,14,1],[167,9,167,10,1],[171,9,171,10,1],[172,13,172,113,1],[174,4,174,41,1],[175,13,175,64,1],[176,13,177,45,1],[178,13,178,67,1],[180,20,180,149,1],[181,13,181,14,1],[182,17,182,52,1],[183,17,183,51,1],[184,13,184,14,1],[185,9,185,10,1],[189,9,189,10,1],[190,13,190,60,1],[191,13,191,61,1],[192,13,193,46,1],[194,13,194,59,1],[195,13,196,51,1],[198,13,198,113,1],[200,4,200,41,1],[201,13,201,64,1],[202,13,203,45,1],[204,13,204,67,1],[206,20,206,149,1],[207,13,207,14,1],[208,17,208,83,1],[210,17,210,49,1],[211,17,211,51,1],[212,13,212,14,1],[213,9,213,10,1],[217,9,217,10,1],[218,13,218,73,1],[219,13,219,68,1],[220,13,220,50,1],[221,13,221,62,1],[223,13,224,79,1],[226,13,226,76,1],[227,13,227,214,1],[228,13,228,140,1],[229,13,229,113,1],[231,13,236,15,1],[238,13,238,50,1],[239,13,239,64,1],[240,13,241,45,1],[242,13,242,67,1],[244,20,244,179,1],[245,13,245,14,1],[246,17,246,64,1],[247,17,247,75,1],[248,17,248,63,1],[250,17,250,217,1],[252,17,252,65,1],[255,17,255,51,1],[256,13,256,14,1],[257,9,257,10,1],[261,9,261,10,1],[262,13,262,73,1],[263,13,263,68,1],[264,13,264,50,1],[265,13,265,75,1],[266,13,266,112,1],[267,13,268,79,1],[270,13,270,83,1],[271,13,271,140,1],[272,13,272,113,1],[274,13,277,15,1],[279,13,279,50,1],[280,13,280,64,1],[281,13,282,45,1],[283,13,283,67,1],[285,20,285,186,1],[286,13,286,14,1],[287,17,287,69,1],[288,17,288,63,1],[290,17,290,117,1],[292,17,292,65,1],[293,17,293,51,1],[294,13,294,14,1],[295,9,295,10,1],[299,9,299,10,1],[300,13,300,129,1],[301,13,302,49,1],[304,13,304,137,1],[305,13,306,44,1],[308,13,308,60,1],[309,13,309,61,1],[310,13,311,46,1],[313,13,313,59,1],[314,13,315,77,1],[316,13,317,51,1],[319,13,319,73,1],[320,13,320,68,1],[321,13,321,50,1],[322,13,322,75,1],[323,13,324,58,1],[326,13,326,83,1],[327,13,328,65,1],[330,13,330,113,1],[332,4,332,41,1],[333,13,333,64,1],[334,13,335,45,1],[336,13,336,67,1],[338,20,338,197,1],[339,13,339,14,1],[340,17,340,83,1],[342,17,342,64,1],[343,17,343,56,1],[344,17,344,51,1],[345,13,345,14,1],[346,9,346,10,1],[350,9,350,10,1],[351,13,351,73,1],[352,13,352,68,1],[353,13,353,50,1],[354,13,354,75,1],[355,13,355,160,1],[356,13,357,79,1],[359,13,359,83,1],[360,13,360,129,1],[361,13,362,48,1],[364,13,364,137,1],[365,13,366,44,1],[368,13,368,59,1],[369,13,370,77,1],[372,13,372,113,1],[374,13,379,15,1],[381,4,381,41,1],[382,13,382,64,1],[383,13,384,45,1],[385,13,385,67,1],[387,20,387,197,1],[388,13,388,14,1],[389,17,389,64,1],[390,17,390,83,1],[392,17,392,79,1],[393,17,393,63,1],[395,17,395,165,1],[397,17,397,75,1],[398,17,398,51,1],[399,13,399,14,1],[400,9,400,10,1],[405,9,405,10,1],[406,13,406,73,1],[407,13,407,68,1],[408,13,408,50,1],[409,13,409,75,1],[411,13,411,83,1],[413,13,413,129,1],[414,13,415,49,1],[417,13,417,137,1],[418,13,419,44,1],[421,13,421,59,1],[422,13,423,77,1],[425,13,425,113,1],[426,13,426,67,1],[427,13,427,55,1],[428,13,428,87,1],[429,13,429,81,1],[431,4,431,41,1],[432,13,432,64,1],[433,13,434,45,1],[436,20,436,197,1],[437,13,437,14,1],[438,17,438,64,1],[440,17,440,83,1],[442,17,442,56,1],[443,17,443,63,1],[445,17,446,77,1],[448,17,448,52,1],[449,17,449,63,1],[451,17,452,41,1],[452,41,452,45,1],[452,45,452,47,1],[451,17,452,47,1],[454,17,454,52,1],[455,17,455,63,1],[456,13,456,14,1],[457,9,457,10,1]]);
    </script>
  </body>
</html>