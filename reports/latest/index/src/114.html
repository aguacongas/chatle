<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\chatle\src\ChatLe.Repository.Identity.Firebase\FirebaseChatStore.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aguacongas.Firebase;
using ChatLe.Models;
using Microsoft.AspNetCore.Identity;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace ChatLe.Repository.Identity.Firebase
{
    public class FirebaseChatStore&lt;TUser, TConversation, TAttendee, TMessage, TNotificationConnection&gt; : IChatStore&lt;string, TUser, TConversation, TAttendee, TMessage, TNotificationConnection&gt;
        where TUser : IdentityUser&lt;string&gt;, IChatUser&lt;string&gt;
        where TConversation : Conversation&lt;string&gt;, new()
        where TAttendee : Attendee&lt;string&gt;
        where TMessage : Message&lt;string&gt;
        where TNotificationConnection : NotificationConnection&lt;string&gt;
    {
        private const string ConversationTableName = &quot;conversations&quot;;
        private const string AttendeeTableName = &quot;attendees&quot;;
        private const string MessageSubTableName = &quot;messages&quot;;
        private const string NotificationConnectionsTableName = &quot;connections&quot;;
        private const string UserCountTableName = &quot;connections-count&quot;;
        private const string RulePath = &quot;.settings/rules.json&quot;;

        private readonly IFirebaseClient _client;
        private readonly IUserStore&lt;TUser&gt; _userStore;

        public FirebaseChatStore(IFirebaseClient client, IUserStore&lt;TUser&gt; userStore)
        {
            _client = client ?? throw new ArgumentNullException(nameof(client));
            _userStore = userStore ?? throw new ArgumentNullException(nameof(userStore));
        }
        public virtual Task CreateAttendeeAsync(TAttendee attendee, CancellationToken cancellationToken = default(CancellationToken))
        {
            attendee = attendee ?? throw new ArgumentNullException(nameof(attendee));

            return _client.PostAsync(GetFirebasePath(AttendeeTableName), attendee, cancellationToken);
        }
        
        public virtual async Task CreateConversationAsync(TConversation conversation, CancellationToken cancellationToken = default(CancellationToken))
        {
            conversation = conversation ?? throw new ArgumentNullException(nameof(conversation));

            var result = await _client.PostAsync(GetFirebasePath(ConversationTableName), conversation, cancellationToken);
            conversation.Id = result.Data;
        }

        public virtual async Task CreateMessageAsync(TMessage message, CancellationToken cancellationToken = default(CancellationToken))
        {
            message = message ?? throw new ArgumentNullException(nameof(message));

            message.Date = DateTime.UtcNow;
            var result = await _client.PostAsync(GetFirebasePath(ConversationTableName, message.ConversationId, MessageSubTableName), message, cancellationToken);
            message.Id = result.Data;
        }

        public virtual Task CreateNotificationConnectionAsync(TNotificationConnection connection, CancellationToken cancellationToken = default(CancellationToken))
        {
            connection = connection ?? throw new ArgumentNullException(nameof(connection));
            return _client.PutAsync(GetFirebasePath(NotificationConnectionsTableName, connection.ConnectionId), connection, cancellationToken);
        }

        public virtual Task DeleteNotificationConnectionAsync(TNotificationConnection connection, CancellationToken cancellationToken = default(CancellationToken))
        {
            connection = connection ?? throw new ArgumentNullException(nameof(connection));
            return _client.DeleteAsync(GetFirebasePath(NotificationConnectionsTableName, connection.ConnectionId), cancellationToken);
        }

        public async virtual Task DeleteUserAsync(TUser user, CancellationToken cancellationToken = default(CancellationToken))
        {
            user = user ?? throw new ArgumentNullException(nameof(user));

            var conversations = await GetConversationsAsync(user, cancellationToken);
            var taskList = new List&lt;Task&gt;();
            foreach (var conversation in conversations)
            {
                taskList.Add(_client.DeleteAsync(GetFirebasePath(ConversationTableName, conversation.Id), cancellationToken));
                taskList.Add(Task.Run(async () =&gt;
                {
                    var attendees = await _client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName), cancellationToken, false, $&quot;orderBy=\&quot;ConversationId\&quot;&amp;equalTo=\&quot;{conversation.Id}\&quot;&quot;);
                    var deleteAttendeeTasks = new List&lt;Task&gt;(attendees.Data.Count);
                    foreach(var attendee in attendees.Data)
                    {
                        deleteAttendeeTasks.Add(_client.DeleteAsync(GetFirebasePath(AttendeeTableName, attendee.Key), cancellationToken));
                    }

                    await Task.WhenAll(deleteAttendeeTasks);
                }));
            }

            taskList.Add(Task.Run(async () =&gt;
            {
                var connections = await _client.GetAsync&lt;Dictionary&lt;string, TNotificationConnection&gt;&gt;(GetFirebasePath(NotificationConnectionsTableName), cancellationToken, false, $&quot;orderBy=\&quot;UserId\&quot;&amp;equalTo=\&quot;{user.Id}\&quot;&quot;);
                var deleteConnectionTasks = new List&lt;Task&gt;(connections.Data.Count);
                foreach (var connection in connections.Data)
                {
                    deleteConnectionTasks.Add(_client.DeleteAsync(GetFirebasePath(NotificationConnectionsTableName, connection.Key), cancellationToken));
                }

                await Task.WhenAll(deleteConnectionTasks);
            }));

           taskList.Add(_userStore.DeleteAsync(user, cancellationToken));

            await Task.WhenAll(taskList);
        }

        public virtual Task&lt;TUser&gt; FindUserByIdAsync(string id, CancellationToken cancellationToken = default(CancellationToken))
            =&gt; GetLoginStore().FindByIdAsync(id, cancellationToken);

        public virtual Task&lt;TUser&gt; FindUserByNameAsync(string userName, CancellationToken cancellationToken = default(CancellationToken))
            =&gt; GetLoginStore().FindByNameAsync(userName, cancellationToken);

        public async virtual Task&lt;TConversation&gt; GetConversationAsync(TUser attendee1, TUser attendee2, CancellationToken cancellationToken = default(CancellationToken))
        {
            attendee1 = attendee1 ?? throw new ArgumentNullException(nameof(attendee1));
            attendee2 = attendee2 ?? throw new ArgumentNullException(nameof(attendee2));

            
            var results = await Task.WhenAll(_client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName), 
                    cancellationToken, 
                    false, 
                    $&quot;orderBy=\&quot;UserId\&quot;&amp;equalTo=\&quot;{attendee1.Id}\&quot;&quot;),
                _client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName),
                    cancellationToken,
                    false,
                    $&quot;orderBy=\&quot;UserId\&quot;&amp;equalTo=\&quot;{attendee2.Id}\&quot;&quot;));

            var match = from id1 in results[0].Data.Values.Select(a =&gt; a.ConversationId)
                        join id2 in results[1].Data.Values.Select(a =&gt; a.ConversationId)
                            on id1 equals id2
                        select id1;

            foreach (var conversationId in match)
            {
                var result = await _client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName),
                    cancellationToken,
                    false,
                    $&quot;orderBy=\&quot;ConversationId\&quot;&amp;equalTo=\&quot;{conversationId}\&quot;&quot;);

                if (result.Data.Count == 2)
                {
                    return await GetConversationAsync(conversationId);
                }
            }

            return null;
        }

        public async virtual Task&lt;TConversation&gt; GetConversationAsync(string toConversationId, CancellationToken cancellationToken = default(CancellationToken))
        {
            if (string.IsNullOrEmpty(toConversationId))
            {
                throw new ArgumentNullException(nameof(toConversationId));
            }

            TConversation conversation = null;
            IEnumerable&lt;TAttendee&gt; attendees = null;
            await Task.WhenAll(Task.Run(async () =&gt;
            {
                if ((await _client.GetAsync&lt;object&gt;(GetFirebasePath(ConversationTableName, toConversationId))).Data != null)
                {
                    conversation = new TConversation();
                    conversation.Id = toConversationId;
                }
            }), Task.Run(async () =&gt;
            {
                var attendeesResult = await _client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName), cancellationToken, false, $&quot;orderBy=\&quot;ConversationId\&quot;&amp;equalTo=\&quot;{toConversationId}\&quot;&quot;);
                if (attendeesResult.Data != null)
                {
                    attendees = attendeesResult.Data.Values;
                }
            }));

            if (conversation == null || attendees == null)
            {
                return null;
            }

            foreach (var attendee in attendees)
            {
                conversation.Attendees.Add(attendee);
            }

            return conversation;
        }

        public async virtual Task&lt;IEnumerable&lt;TConversation&gt;&gt; GetConversationsAsync(TUser user, CancellationToken cancellationToken = default(CancellationToken))
        {
            user = user ?? throw new ArgumentNullException(nameof(user));

            var conversationIds = (await _client.GetAsync&lt;Dictionary&lt;string, TAttendee&gt;&gt;(GetFirebasePath(AttendeeTableName),
                cancellationToken,
                false,
                $&quot;orderBy=\&quot;UserId\&quot;&amp;equalTo=\&quot;{user.Id}\&quot;&quot;)).Data.Values.Select(a =&gt; a.ConversationId);

            var taskList = new List&lt;Task&lt;TConversation&gt;&gt;(conversationIds.Count());
            foreach(var id in conversationIds)
            {
                taskList.Add(GetConversationAsync(id, cancellationToken));
            }

            var results = await Task.WhenAll(taskList);

            return results.Where(c =&gt; c!= null).Select(c =&gt; c);
        }

        public async virtual Task&lt;IEnumerable&lt;TMessage&gt;&gt; GetMessagesAsync(string convId, int max = 50, CancellationToken cancellationToken = default(CancellationToken))
        {
            if (string.IsNullOrEmpty(convId))
            {
                throw new ArgumentNullException(nameof(convId));
            }

            return (await _client.GetAsync&lt;Dictionary&lt;string, TMessage&gt;&gt;(GetFirebasePath(ConversationTableName, convId, MessageSubTableName),
                cancellationToken, false, $&quot;orderBy\&quot;$priority\&quot;&amp;limiteToFirst=\&quot;{max}\&quot;&quot;))
                .Data?.Values.OrderByDescending(m =&gt; m.Date).Take(max);
        }

        public async virtual Task&lt;TNotificationConnection&gt; GetNotificationConnectionAsync(string connectionId, string notificationType, CancellationToken cancellationToken = default(CancellationToken))
        {
            if (string.IsNullOrEmpty(connectionId))
            {
                throw new ArgumentNullException(nameof(connectionId));
            }
            if (string.IsNullOrEmpty(notificationType))
            {
                throw new ArgumentNullException(nameof(notificationType));
            }

            return (await _client.GetAsync&lt;TNotificationConnection&gt;(GetFirebasePath(NotificationConnectionsTableName, connectionId), cancellationToken)).Data;
        }

        public async virtual Task&lt;Page&lt;TUser&gt;&gt; GetUsersConnectedAsync(int pageIndex = 0, int pageLength = 50, CancellationToken cancellationToken = default(CancellationToken))
        {
            var countResult = await _client.GetAsync&lt;int?&gt;(GetFirebasePath(UserCountTableName), cancellationToken);
            var count = countResult.Data;

            if (!count.HasValue || count == 0)
            {
                return new Page&lt;TUser&gt;(new List&lt;TUser&gt;(0), pageIndex, 0);
            }

            var limitBottom = count - (pageIndex * pageLength);

            var result = (await _client.GetAsync&lt;Dictionary&lt;string, TNotificationConnection&gt;&gt;(GetFirebasePath(NotificationConnectionsTableName),
                cancellationToken,
                false,
                $&quot;orderBy=\&quot;ConnectionDate\&quot;&amp;limitToLast={limitBottom}&quot;)).Data;

            if (result == null)
            {
                return new Page&lt;TUser&gt;(new List&lt;TUser&gt;(0), pageIndex, 0);
            }

            var userIds = result.Values
                .OrderByDescending(n =&gt; n.ConnectionDate)
                .Take(pageLength)
                .Select(n =&gt; n.UserId);

            var taskList = new List&lt;Task&lt;TUser&gt;&gt;(userIds.Count());
            foreach(var id in userIds)
            {
                taskList.Add(_userStore.FindByIdAsync(id, cancellationToken));
            }
            var users = await Task.WhenAll(taskList);
            return new Page&lt;TUser&gt;(users, pageIndex, count.Value / pageLength);
        }

        public virtual void Init()
        {
            var response = _client.GetAsync&lt;FirebaseRules&gt;(RulePath).GetAwaiter().GetResult();
            var rules = response.Data ?? new FirebaseRules();
            var indexes = rules.Rules ?? new Dictionary&lt;string, object&gt;();
            indexes[AttendeeTableName] = new FirebaseIndexes
            {
                On = new string[] { &quot;UserId&quot;, &quot;ConversationId&quot; }
            };
            indexes[NotificationConnectionsTableName] = new FirebaseIndexes
            {
                On = new string[] { &quot;ConnectionDate&quot;, &quot;UserId&quot; }
            };

            Task.WaitAll(_client.PutAsync(RulePath, rules),
                _client.DeleteAsync(NotificationConnectionsTableName));
        }

        public virtual async Task&lt;bool&gt; IsGuess(TUser user, CancellationToken cancellationToken = default(CancellationToken)) 
            =&gt; (await GetLoginStore().GetLoginsAsync(user, cancellationToken)).Any() == false;
       
        public async virtual Task&lt;bool&gt; UserHasConnectionAsync(TUser user)
        {
            user = user ?? throw new ArgumentNullException(nameof(user));

            var result = await _client.GetAsync&lt;Dictionary&lt;string, TNotificationConnection&gt;&gt;(GetFirebasePath(NotificationConnectionsTableName), default(CancellationToken), false, $&quot;orderBy=\&quot;UserId\&quot;&amp;equalTo=\&quot;{user.Id}\&quot;&quot;);
            return result.Data != null &amp;&amp; result.Data.Count &gt; 0;
        }

        protected virtual IUserLoginStore&lt;TUser&gt; GetLoginStore()
            =&gt; _userStore is IUserLoginStore&lt;TUser&gt; ? _userStore as IUserLoginStore&lt;TUser&gt; : throw new InvalidOperationException(&quot;User store doesn&#39;t implement IUserLoginStore&lt;TUser&gt;&quot;);

        protected virtual string GetFirebasePath(params string[] segments)
        {
            return string.Join(&quot;/&quot;, segments);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,9,30,86,1],[31,9,31,10,1],[32,13,32,81,1],[33,13,33,90,1],[34,9,34,10,1],[36,9,36,10,1],[37,13,37,86,1],[39,13,39,103,1],[40,9,40,10,1],[43,9,43,10,1],[44,13,44,98,1],[46,13,46,123,1],[47,13,47,43,1],[48,9,48,10,1],[51,9,51,10,1],[52,13,52,83,1],[54,13,54,44,1],[55,13,55,163,1],[56,13,56,38,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,92,1],[62,13,62,144,1],[63,9,63,10,1],[66,9,66,10,1],[67,13,67,92,1],[68,13,68,135,1],[69,9,69,10,1],[72,9,72,10,1],[73,13,73,74,1],[75,13,75,86,1],[76,13,76,45,1],[77,13,77,20,1],[77,22,77,38,0],[77,39,77,41,1],[77,42,77,55,1],[78,13,78,14,0],[79,17,79,127,0],[80,17,81,17,0],[81,17,81,18,0],[81,18,82,21,0],[82,21,82,214,0],[82,214,83,21,0],[83,21,83,84,0],[83,84,84,21,0],[84,21,84,28,0],[84,28,84,29,0],[84,29,84,41,0],[84,41,84,42,0],[84,42,84,44,0],[84,44,84,45,0],[84,45,84,59,0],[84,59,85,21,0],[85,21,85,22,0],[85,22,86,25,0],[86,25,86,139,0],[86,139,87,21,0],[87,21,87,22,0],[87,22,89,21,0],[89,21,89,61,0],[89,61,90,17,0],[90,17,90,18,0],[90,18,90,21,0],[80,17,90,21,0],[91,13,91,14,0],[93,13,94,13,1],[94,13,94,14,1],[94,14,95,17,1],[95,17,95,225,1],[95,225,96,17,1],[96,17,96,84,1],[96,84,97,17,1],[97,17,97,24,1],[97,24,97,26,1],[97,26,97,40,1],[97,40,97,41,1],[97,41,97,43,1],[97,43,97,44,1],[97,44,97,60,1],[97,60,98,17,1],[98,17,98,18,1],[98,18,99,21,1],[99,21,99,154,1],[99,154,100,17,1],[100,17,100,18,1],[100,18,102,17,1],[102,17,102,59,1],[102,59,103,13,1],[103,13,103,14,1],[103,14,103,17,1],[93,13,103,17,1],[105,12,105,74,1],[107,13,107,42,1],[108,9,108,10,1],[111,16,111,68,1],[114,16,114,76,1],[117,9,117,10,1],[118,13,118,89,1],[119,13,119,89,1],[122,13,129,72,1],[131,13,131,72,1],[131,72,131,88,1],[131,88,132,72,1],[132,72,132,88,1],[132,88,133,32,1],[133,32,133,35,1],[133,35,133,43,1],[133,43,133,46,1],[133,46,134,32,1],[134,32,134,35,1],[134,35,134,36,1],[131,13,134,36,1],[136,13,136,20,1],[136,22,136,40,1],[136,41,136,43,1],[136,44,136,49,1],[137,13,137,14,1],[138,17,141,81,1],[143,17,143,44,1],[144,17,144,18,1],[145,21,145,71,1],[147,13,147,14,0],[149,13,149,25,1],[150,9,150,10,1],[153,9,153,10,1],[154,13,154,56,1],[155,13,155,14,0],[156,17,156,75,0],[159,13,159,47,1],[160,13,160,53,1],[161,13,162,13,1],[162,13,162,14,1],[162,14,163,17,1],[163,17,163,125,1],[163,125,164,17,1],[164,17,164,18,1],[164,18,165,21,1],[165,21,165,56,1],[165,56,166,21,1],[166,21,166,56,1],[166,56,167,17,1],[167,17,167,18,1],[167,18,168,13,1],[168,13,168,14,1],[168,14,169,13,1],[169,13,169,14,1],[169,14,170,17,1],[170,17,170,217,1],[170,217,171,17,1],[171,17,171,50,1],[171,50,172,17,1],[172,17,172,18,1],[172,18,173,21,1],[173,21,173,61,1],[173,61,174,17,1],[174,17,174,18,1],[174,18,175,13,1],[175,13,175,14,1],[175,14,175,17,1],[161,13,175,17,1],[177,13,177,59,1],[178,13,178,14,0],[179,17,179,29,0],[182,13,182,20,1],[182,22,182,34,1],[182,35,182,37,1],[182,38,182,47,1],[183,13,183,14,1],[184,17,184,54,1],[185,13,185,14,1],[187,13,187,33,1],[188,9,188,10,1],[191,9,191,10,1],[192,13,192,74,1],[194,13,197,87,1],[197,87,197,103,0],[197,103,197,105,1],[194,13,197,105,1],[199,13,199,83,1],[200,13,200,20,1],[200,21,200,27,0],[200,28,200,30,1],[200,31,200,46,1],[201,13,201,14,0],[202,17,202,75,0],[203,13,203,14,0],[205,13,205,56,1],[207,13,207,39,1],[207,39,207,47,0],[207,47,207,61,1],[207,61,207,62,0],[207,62,207,64,1],[207,13,207,64,1],[208,9,208,10,1],[211,9,211,10,1],[212,13,212,46,1],[213,13,213,14,1],[214,17,214,65,1],[217,13,219,54,1],[219,54,219,60,1],[219,60,219,72,1],[217,13,219,72,1],[220,9,220,10,1],[223,9,223,10,1],[224,13,224,52,1],[225,13,225,14,1],[226,17,226,71,1],[228,13,228,56,1],[229,13,229,14,1],[230,17,230,75,1],[233,13,233,159,1],[234,9,234,10,1],[237,9,237,10,0],[238,13,238,116,0],[239,13,239,42,0],[241,13,241,47,0],[242,13,242,14,0],[243,17,243,74,0],[246,13,246,64,0],[248,13,251,80,0],[253,13,253,32,0],[254,13,254,14,0],[255,17,255,74,0],[258,13,259,41,0],[259,41,259,57,0],[259,57,261,30,0],[261,30,261,38,0],[261,38,261,40,0],[258,13,261,40,0],[263,13,263,67,0],[264,13,264,20,0],[264,21,264,27,0],[264,28,264,30,0],[264,31,264,38,0],[265,13,265,14,0],[266,17,266,79,0],[267,13,267,14,0],[268,13,268,54,0],[269,13,269,80,0],[270,9,270,10,0],[273,9,273,10,1],[274,13,274,95,1],[275,13,275,62,1],[276,13,276,75,1],[277,13,280,15,1],[281,13,284,15,1],[286,13,287,72,1],[288,9,288,10,1],[291,16,291,94,1],[294,9,294,10,1],[295,13,295,74,1],[297,13,297,225,0],[298,13,298,65,0],[299,9,299,10,0],[302,16,302,184,1],[305,9,305,10,1],[306,13,306,47,1],[307,9,307,10,1]]);
    </script>
  </body>
</html>